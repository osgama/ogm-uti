<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Descarga Archivos</title>
  <link id="themeStylesheet" rel="stylesheet" href="../css/dark-gray-blue-accent-v1.css">
</head>

<body>

  <header style="position: relative;">
    <h1>Descarga Archivos <span id="ambiente"></span></h1>
  </header>
  <div
    style="position: fixed; bottom: 10px; right: 10px; font-size: 0.8em; color: gray; pointer-events: none; z-index: 1000;">
    Versión 1.0.0
  </div>


  <main>
    <label for="directorio">Directorio:</label>
    <select id="directorio" name="directorio">
      <option value="1">logs 1</option>
      <option value="2">logs 2</option>
      <option value="3">logs 3</option>
      <option value="4">logs 4</option>
      <option value="5">logs 5</option>
      <option value="6">logs 6</option>
      <option value="7">logs 7</option>
      <option value="8">logs 8</option>
      <option value="9">logs 9</option>
      <option value="10">logs 10</option>
      <option value="11">logs 11</option>
      <option value="12">logs 12</option>
      <option value="13">logs 13</option>
      <option value="14">logs 14</option>
      <option value="15">logs 15</option>
      <option value="16">logs 16</option>
      <option value="17">logs 17</option>
      <option value="18">logs 18</option>
      <option value="19">logs 19</option>
      <option value="20">logs 20</option>
      <option value="21">logs 21</option>
    </select>

    <label for="filtro">Filtro:</label>
    <input type="text" id="filtro" name="filtro" placeholder="Filtro de archivos">
    <button onclick="listarArchivos()">Buscar</button>
    <button onclick="descargarSeleccionados()">Descargar</button>
    <button onclick="seleccionarTodos()">Seleccionar Todos</button>
    <button onclick="limpiar()">Limpiar</button>

    <span id="totalArchivosInfo"></span>
    <div id="div3"></div>
    <div id="archivos"></div>

    <p id="msjNoArchivos" class="mensaje warning">¡NO SE ENCONTRARON ARCHIVOS!</p>
    <p id="msjEspera" class="mensaje warning">Por favor espera... buscando archivos...</p>

    <div id="errorMessage" class="mensaje error"></div>

    <input type="hidden" id="directorioDescarga" name="directorio" />
    <input type="hidden" id="archivosDescarga" name="archivos" />
  </main>

  <footer id="themeSelectorContainer"
    style="position: fixed; bottom: 10px; left: 10px; padding: 5px 10px; font-size: 0.9em; background-color: transparent;">
    <select id="cssSwitcher" onchange="cambiarCSS()"
      style="background-color: transparent; color: inherit; border: 1px solid rgba(255, 255, 255, 0.3); padding: 3px; border-radius: 3px;"
      onfocus="this.style.backgroundColor='rgba(255, 255, 255, 0.8)'; this.style.color='#333';"
      onblur="this.style.backgroundColor='transparent'; this.style.color='inherit';">
      <option value="../css/calm-dark-neutral-v1.css">Calm Dark Neutral V1</option>
      <option value="../css/calm-dark-v2.css">Calm Dark V2</option>
      <option value="../css/calm-neutral-v1.css">Calm Neutral V1</option>
      <option value="../css/dark-blue-accent-v1.css">Dark Blue Accent V1</option>
      <option value="../css/dark-blue-v1.css">Dark Blue V1</option>
      <option value="../css/dark-cyan-accent-v1.css">Dark Cyan Accent V1</option>
      <option value="../css/dark-deep-blue-v1.css">Dark Deep Blue V1</option>
      <option value="../css/dark-elegant-mint-v1.css">Dark Elegant Mint V1</option>
      <option value="../css/dark-elegant-neutral-v1.css">Dark Elegant Neutral V1</option>
      <option value="../css/dark-forest-neutral-v1.css">Dark Forest Neutral V1</option>
      <option value="../css/dark-golden-v1.css">Dark Golden V1</option>
      <option value="../css/dark-gray-blue-accent-v1.css">Dark Gray Blue Accent V1</option>
      <option value="../css/dark-green-accent-v1.css">Dark Green Accent V1</option>
      <option value="../css/dark-lilac-v1.css">Dark Lilac V1</option>
      <option value="../css/dark-modern-v1.css">Dark Modern V1</option>
      <option value="../css/dark-modern-vibrant-v1.css">Dark Modern Vibrant V1</option>
      <option value="../css/dark-navy-accent-v1.css">Dark Navy Accent V1</option>
      <option value="../css/dark-neutral-v1.css">Dark Neutral V1</option>
      <option value="../css/dark-neutral-v2.css">Dark Neutral V2</option>
      <option value="../css/dark-professional-vibe-v1.css">Dark Professional Vibe V1</option>
      <option value="../css/dark-red-accent-v1.css">Dark Red Accent V1</option>
      <option value="../css/dark-steel-blue-accent-v1.css">Dark Steel Blue Accent V1</option>
      <option value="../css/dark-teal-accent-v1.css">Dark Teal Accent V1</option>
      <option value="../css/dark-teal-gray-accent-v1.css">Dark Teal Gray Accent V1</option>
      <option value="../css/dark-teal-v1.css">Dark Teal V1</option>
      <option value="../css/dark-vibrant-blue-accent-v1.css">Dark Vibrant Blue Accent V1</option>
      <option value="../css/dark-vibrant-earth-v1.css">Dark Vibrant Earth V1</option>
      <option value="../css/deep-black-blue-accent-v1.css">Deep Black Blue Accent V1</option>
      <option value="../css/earth-tones-v1.css">Earth Tones V1</option>
      <option value="../css/earth-tones-v2.css">Earth Tones V2</option>
      <option value="../css/light-dark-muted-v1.css">Light Dark Muted V1</option>
      <option value="../css/light-dark-muted-v2.css">Light Dark Muted V2</option>
      <option value="../css/light-dark-muted-v3.css">Light Dark Muted V3</option>
      <option value="../css/light-gray-v1.css">Light Gray V1</option>
      <option value="../css/light-pastel-v1.css">Light Pastel V1</option>
      <option value="../css/modern-dark-contrast-v1.css">Modern Dark Contrast V1</option>
      <option value="../css/modern-dark-contrast-v2.css">Modern Dark Contrast V2</option>
      <option value="../css/neutral-dark-sandstone-v1.css">Neutral Dark Sandstone V1</option>
      <option value="../css/neutral-sandstone-v1.css">Neutral Sandstone V1</option>
      <option value="../css/soft-light-v1.css">Soft Light V1</option>
      <option value="../css/teal-accent-dark-v1.css">Teal Accent Dark V1</option>
      <option value="../css/urban-dark-neutral-v1.css">Urban Dark Neutral V1</option>
      <option value="../css/warm-dark-neutral-v1.css">Warm Dark Neutral V1</option>
    </select>
  </footer>

  <script>
    let archivosSeleccionados = [];

    function obtenerAmbiente() {
      fetch(`http://localhost:9093/api/ambiente`)
        .then((response) => {
          if (!response.ok) {
            throw new Error('Hubo un problema al obtener el ambiente.');
          }
          return response.text();
        })
        .then((ambiente) => {
          document.getElementById('ambiente').textContent = ambiente;
        })
        .catch((error) => {
          mostrarError('Error al obtener el ambiente.');
        });
    }

    window.onload = function () {
      obtenerAmbiente();
      aplicarTemaGuardado();
    };

    function listarArchivos() {
      document.getElementById("msjEspera").style.display = "block";
      const directorio = document.getElementById("directorio").value;
      const filtro = document.getElementById("filtro").value;
      const tipo = '1';
      limpiarSeleccion();
      fetch(`http://localhost:9093/api/lista`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          directorio: directorio,
          filtro: filtro,
          tipo: tipo,
        }),
      })
        .then((response) => {
          if (!response.ok) {
            const errorMessage = response.headers.get("X-Error-Message") || "Hubo un problema al obtener la lista de archivos.";
            mostrarError(errorMessage);
            return null;
          }
          return response.json();
        })
        .then((data) => {
          if (data === null) return;

          if (data.length === 0) {
            document.getElementById("msjNoArchivos").style.display = "block";
          } else {
            document.getElementById("msjNoArchivos").style.display = "none";
          }
          mostrarArchivos(data);
        })
        .catch((error) => {
          mostrarError("Ocurrió un error inesperado al listar los archivos.");
        })
        .finally(() => {
          document.getElementById("msjEspera").style.display = "none";
        });
    }

    function mostrarArchivos(archivos) {
      const archivosDiv = document.getElementById("archivos");
      archivosDiv.innerHTML = "";

      let html = "<table><tr>";
      const headers = ["Nombre", "Tamaño", "Fecha (DD/MM/YYYY)", "Seleccionar"];
      headers.forEach(header => {
        html += `<th>${header}</th>`;
      });
      html += "</tr>";

      archivos.forEach(archivo => {
        const detalles = archivo.split("||");
        html += "<tr>";
        html += `<td>${detalles[0]}</td>`;
        html += `<td>${detalles[1]}</td>`;
        html += `<td>${detalles[2]}</td>`;
        html += `<td><input type="checkbox" value="${detalles[0]}" onchange="handleCheckboxChange(event)"></td>`;
        html += "</tr>";
      });
      html += "</table>";
      archivosDiv.innerHTML = html;
      const totalArchivos = archivos.length;
      document.getElementById("totalArchivosInfo").textContent = `Encontrados: ${totalArchivos}`;
    }

    function handleCheckboxChange(event) {
      const checkbox = event.target;
      const nombreArchivo = checkbox.value;
      if (checkbox.checked) {
        archivosSeleccionados.push(nombreArchivo);
      } else {
        const index = archivosSeleccionados.indexOf(nombreArchivo);
        if (index !== -1) {
          archivosSeleccionados.splice(index, 1);
        }
      }
      document.getElementById("directorioDescarga").value = document.getElementById("directorio").value;
      document.getElementById("archivosDescarga").value = JSON.stringify(archivosSeleccionados);
    }

    function seleccionarTodos() {
      const checkboxes = document.querySelectorAll("input[type='checkbox']");
      archivosSeleccionados = [];
      checkboxes.forEach((checkbox) => {
        checkbox.checked = true;
        archivosSeleccionados.push(checkbox.value);
      });
      document.getElementById("directorioDescarga").value = document.getElementById("directorio").value;
      document.getElementById("archivosDescarga").value = JSON.stringify(archivosSeleccionados);
    }

    function descargarSeleccionados() {
    const directorio = document.getElementById("directorio").value;

    console.log("Iniciando descarga...");
    fetch(`http://localhost:9093/api/ambiente`)
        .then(response => response.text())
        .then(ambiente => {
            console.log("Ambiente recibido:", ambiente);

            let archivosSeleccionadosStr = JSON.stringify(archivosSeleccionados);
            let password = null;
            const tipo = '1';

            if (ambiente.trim().toUpperCase() === "PROD") {
                password = prompt("Introduce la contraseña para el archivo ZIP:");
                if (!password) {
                    mostrarError("Debes proporcionar una contraseña.");
                    console.log("Descarga cancelada: No se proporcionó contraseña");
                    return;
                }
                console.log("Contraseña ingresada para ambiente PROD.");
            }

            if (archivosSeleccionados.length === 0) {
                mostrarError("Selecciona al menos un archivo para descargar.");
                console.log("Descarga cancelada: No se seleccionaron archivos");
                return;
            }

            if (archivosSeleccionados.length === 1 && ambiente.trim().toUpperCase() !== "PROD") {
                const archivo = archivosSeleccionados[0];
                console.log("Descarga directa de un solo archivo:", archivo);
                window.location.href = `http://localhost:9093/api/descargar?directorio=${encodeURIComponent(directorio)}&archivo=${encodeURIComponent(archivo)}&tipo=1`;
                return;
            }

            let formData = new FormData();
            formData.append("directorio", directorio);
            formData.append("archivos", archivosSeleccionadosStr);
            formData.append("tipo", tipo);
            if (password) {
                formData.append("password", password);
            }

            console.log("Enviando solicitud de descarga de ZIP con archivos:", archivosSeleccionados);

            fetch(`http://localhost:9093/api/descargar-zip`, {
                method: "POST",
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    const contentDisposition = response.headers.get("Content-Disposition");
                    console.log("Encabezado Content-Disposition recibido:", contentDisposition);

                    let fileName = "archivos.zip";
                    if (contentDisposition && contentDisposition.includes("filename=")) {
                        fileName = contentDisposition.split("filename=")[1].trim().replace(/"/g, '');
                    }
                    console.log("Nombre del archivo a descargar:", fileName);
                    return response.blob().then(blob => ({ blob, fileName }));
                } else {
                    mostrarError("Error al generar el archivo ZIP.");
                    console.error("Error en respuesta del servidor al generar ZIP.");
                    throw new Error("Error al generar el archivo ZIP.");
                }
            })
            .then(({ blob, fileName }) => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.setAttribute("download", fileName)
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                console.log("Archivo descargado exitosamente:", fileName);
            })
            .catch(error => {
                mostrarError("Ocurrió un error al descargar los archivos.");
                console.error("Error en el proceso de descarga:", error);
            });
        })
        .catch(error => {
            mostrarError("Error al verificar el ambiente.");
            console.error("Error al obtener el ambiente:", error);
        });
}


    function limpiarSeleccion() {
      const checkboxes = document.querySelectorAll("input[type='checkbox']");
      checkboxes.forEach((checkbox) => {
        checkbox.checked = false;
      });
      archivosSeleccionados = [];
      document.getElementById("directorioDescarga").value = "";
      document.getElementById("archivosDescarga").value = "";
      document.getElementById("msjNoArchivos").style.display = "none";
      const archivosDiv = document.getElementById("archivos");
      archivosDiv.textContent = "";
    }

    function limpiar() {
      const checkboxes = document.querySelectorAll("input[type='checkbox']");
      checkboxes.forEach((checkbox) => {
        checkbox.checked = false;
      });
      archivosSeleccionados = [];
      document.getElementById("filtro").value = "";
    }

    var filtroInput = document.getElementById("filtro");
    filtroInput.addEventListener("keypress", function (event) {
      if (event.key === "Enter") {
        listarArchivos();
      }
    });

    function mostrarError(mensaje) {
      const errorDiv = document.getElementById("errorMessage");
      errorDiv.textContent = mensaje;
      errorDiv.style.display = "block";
      setTimeout(() => {
        errorDiv.style.display = "none";
      }, 5000);
    }

    function aplicarTemaGuardado() {
      const temaGuardado = localStorage.getItem('temaSeleccionado');
      if (temaGuardado) {
        document.getElementById('themeStylesheet').href = temaGuardado;
        document.getElementById('cssSwitcher').value = temaGuardado;
      }
    }

    function cambiarCSS() {
      const cssLink = document.getElementById('themeStylesheet');
      const nuevoCSS = document.getElementById('cssSwitcher').value;
      cssLink.href = nuevoCSS;
      localStorage.setItem('temaSeleccionado', nuevoCSS);
    }


  </script>
</body>

</html>